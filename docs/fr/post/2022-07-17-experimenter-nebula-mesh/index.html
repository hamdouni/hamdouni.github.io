<!DOCTYPE html>
<html lang="en"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Brahim Hamdouni&#39;s website">
<title>Brahim Hamdouni  ·  ابراهيم - Expérimenter Nebula Mesh - Partie 1</title>
<link rel="stylesheet" href="/css/style.css">
<body><nav>
    <details>
        <summary>
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon open" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon close" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                <span>
                    Brahim Hamdouni  ·  ابراهيم
                </span>
            </div>
            
        </summary>
        <div class="links">
            <a href='/'>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Accueil
            </a>
            <a href='/post'>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                </svg>
                Articles
            </a>
            <a href='/lists'>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
                </svg>
                Listes
            </a>
            <a href='/search'>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Recherche
            </a>
        </div>
    </details>
</nav>
<div id="content">
<main>
    <header>
        <h1>Expérimenter Nebula Mesh - Partie 1</h1>
        <em></em>
        <div class="date"> samedi 16 juillet 2022 · 4 minutes · 819 mots </div>
    </header>
    <article>

        <p>Simulons un réseau maillé (mesh en anglais) avec <a href="https://www.defined.net/nebula/">Nebula</a> en configurant 2 machines virtuelles à l&rsquo;aide de <a href="https://www.vagrantup.com">Vagrant</a>.</p>
<p>Le tout sera fait sur ma distribution Linux (Ubuntu 20.04) où j&rsquo;ai déjà <a href="https://www.numetopia.fr/installer-virtualbox-sur-ubuntu-ou-linux-mint/">installé Virtualbox</a>.</p>
<h2 id="vagrant">Vagrant</h2>
<p><a href="https://www.vagrantup.com/">Vagrant</a> est un outil de gestion de machines virtuelles de la société Hashicorp.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo apt install -y vagrant
</code></pre></div><p>Je configure vagrant de telle façon à avoir 2 machines virtuelles sous debian 11, nommées boxA et boxB.</p>
<p>Leur interface réseau est directement branchée au réseau de ma machine, soit <code>eth0</code> (à adapter selon sa propre configuration), pour avoir une IP sur mon réseau local via DHCP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cat <span style="color:#e6db74">&lt;&lt;EOF &gt; Vagrantfile
</span><span style="color:#e6db74">Vagrant.configure(&#34;2&#34;) do |config|
</span><span style="color:#e6db74">    config.vm.define &#34;boxA&#34; do |boxA|
</span><span style="color:#e6db74">        boxA.vm.box = &#34;generic/debian11&#34;
</span><span style="color:#e6db74">        boxA.vm.network &#34;public_network&#34;, bridge: &#34;eth0&#34;
</span><span style="color:#e6db74">    end
</span><span style="color:#e6db74">    config.vm.define &#34;boxB&#34; do |boxB|
</span><span style="color:#e6db74">        boxB.vm.box = &#34;generic/debian11&#34;
</span><span style="color:#e6db74">        boxB.vm.network &#34;public_network&#34;, bridge: &#34;eth0&#34;
</span><span style="color:#e6db74">    end
</span><span style="color:#e6db74">end
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p>Je lance les machines virtuelles avec la commande :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">vagrant up
</code></pre></div><h2 id="nebula">Nebula</h2>
<p>Pour nebula, je récupère les binaires depuis <a href="https://github.com/slackhq/nebula/releases">github</a> selon ma configuration, en l&rsquo;occurrence <code>nebula-linux-amd64.tar.gz</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">wget https://github.com/slackhq/nebula/releases/download/v1.6.0/nebula-linux-amd64.tar.gz
</code></pre></div><p>Ensuite, je décompresse l&rsquo;archive :</p>
<pre tabindex="0"><code>tar xf nebula-linux-amd64.tar.gz
</code></pre><p>J&rsquo;obtiens 2 binaires : nebula et nebula-cert.</p>
<p>Le binaire <code>nebula</code> sera à recopier et exécuter dans les machines virtuelles (voir plus bas). C&rsquo;est lui qui établiera le pont entre les machines.</p>
<p>Le binaire <code>nebula-cert</code> sert à générer tous les certificats nécessaires :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./nebula-cert ca -name <span style="color:#e6db74">&#34;ACME, Inc&#34;</span>
./nebula-cert sign -name <span style="color:#e6db74">&#34;boxA&#34;</span> -ip <span style="color:#e6db74">&#34;192.168.168.100/24&#34;</span>
./nebula-cert sign -name <span style="color:#e6db74">&#34;boxB&#34;</span> -ip <span style="color:#e6db74">&#34;192.168.168.200/24&#34;</span>
</code></pre></div><p>J&rsquo;indique les IP que j&rsquo;utiliserai pour le réseau maillé : <code>192.168.168.100</code> pour boxA et <code>192.168.168.200</code> pour boxB.</p>
<p>J&rsquo;obtiens les fichiers suivants :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ca.crt
ca.key
boxA.crt
boxA.key
boxB.crt
boxB.key
</code></pre></div><p>Pour faciliter la gestion des configurations, je vais créer un dossier par machine virtuelle et j&rsquo;y déplacerai les fichiers respectifs :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mkdir boxA boxB
mv boxA.* boxA <span style="color:#f92672">&amp;&amp;</span> mv boxB.* boxB
</code></pre></div><p>Je génère un fichier de configuration nebula qui sera commun pour les deux machines.</p>
<p>Pour cela, je dois d&rsquo;abord récupèrer leur IP publique (pas l&rsquo;IP interne vagrant mais bien celle de mon réseau local) qui doit être sur l&rsquo;eth1 de la VM:</p>
<p>D&rsquo;abord sur boxA :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">boxAip<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>vagrant ssh boxA --no-tty -c <span style="color:#e6db74">&#34;ip address show eth1| grep &#39;inet &#39; | sed -e &#39;s/^.*inet //&#39; -e &#39;s/\/.*</span>$<span style="color:#e6db74">//&#39;&#34;</span> | tr -d <span style="color:#e6db74">&#39;\r&#39;</span><span style="color:#66d9ef">)</span>
</code></pre></div><p>Ensuite sur boxB :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">boxBip<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>vagrant ssh boxB --no-tty -c <span style="color:#e6db74">&#34;ip address show eth1| grep &#39;inet &#39; | sed -e &#39;s/^.*inet //&#39; -e &#39;s/\/.*</span>$<span style="color:#e6db74">//&#39;&#34;</span> | tr -d <span style="color:#e6db74">&#39;\r&#39;</span><span style="color:#66d9ef">)</span>
</code></pre></div><p>Les 2 adresses IP seront rangées dans les variables d&rsquo;environnement <code>$boxAip</code> et <code>$boxBip</code>.</p>
<p>Ces 2 variables sont utilisées dans la configuration de Nebula ci-dessous,  dans la section <code>static_host_map</code> : les IP obtenues plus haut sont injectées pour faire la correspondance avec l&rsquo;IP maillée (192.168.168.xxx)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cat <span style="color:#e6db74">&lt;&lt;EOF &gt; config.yml
</span><span style="color:#e6db74">pki:
</span><span style="color:#e6db74">  ca: /etc/nebula/ca.crt
</span><span style="color:#e6db74">  cert: /etc/nebula/host.crt
</span><span style="color:#e6db74">  key: /etc/nebula/host.key
</span><span style="color:#e6db74">static_host_map:
</span><span style="color:#e6db74">    &#34;192.168.168.100&#34;: [&#34;$boxAip:4242&#34;]
</span><span style="color:#e6db74">    &#34;192.168.168.200&#34;: [&#34;$boxBip:4242&#34;]
</span><span style="color:#e6db74">lighthouse:
</span><span style="color:#e6db74">  am_lighthouse: false
</span><span style="color:#e6db74">listen:
</span><span style="color:#e6db74">  host: 0.0.0.0
</span><span style="color:#e6db74">  port: 4242
</span><span style="color:#e6db74">punchy:
</span><span style="color:#e6db74">  punch: true
</span><span style="color:#e6db74">tun:
</span><span style="color:#e6db74">  disabled: false
</span><span style="color:#e6db74">  dev: nebula1
</span><span style="color:#e6db74">  drop_local_broadcast: false
</span><span style="color:#e6db74">  drop_multicast: false
</span><span style="color:#e6db74">  tx_queue: 500
</span><span style="color:#e6db74">  mtu: 1300
</span><span style="color:#e6db74">  routes:
</span><span style="color:#e6db74">  unsafe_routes:
</span><span style="color:#e6db74">logging:
</span><span style="color:#e6db74">  level: info
</span><span style="color:#e6db74">  format: text
</span><span style="color:#e6db74">firewall:
</span><span style="color:#e6db74">  conntrack:
</span><span style="color:#e6db74">    tcp_timeout: 12m
</span><span style="color:#e6db74">    udp_timeout: 3m
</span><span style="color:#e6db74">    default_timeout: 10m
</span><span style="color:#e6db74">    max_connections: 100000
</span><span style="color:#e6db74">  outbound:
</span><span style="color:#e6db74">    - port: any
</span><span style="color:#e6db74">      proto: any
</span><span style="color:#e6db74">      host: any
</span><span style="color:#e6db74">  inbound:
</span><span style="color:#e6db74">    - port: any
</span><span style="color:#e6db74">      proto: any
</span><span style="color:#e6db74">      host: any
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><h2 id="configurons-les-machines-virtuelles">Configurons les machines virtuelles</h2>
<p>On doit envoyer tous les fichiers nécessaires sur chacune des machines :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># pour uploader depuis le host vers les vms</span>
vagrant upload ./boxA /tmp/ boxA
vagrant upload ./boxB /tmp/ boxB

<span style="color:#75715e"># il faut aussi uploader le ca.crt</span>
vagrant upload ca.crt /tmp/ boxA
vagrant upload ca.crt /tmp/ boxB

<span style="color:#75715e"># la config nebula</span>
vagrant upload config.yml /tmp/ boxA
vagrant upload config.yml /tmp/ boxB

<span style="color:#75715e"># et le binaire nebula</span>
vagrant upload nebula /tmp/ boxA
vagrant upload nebula /tmp/ boxB
</code></pre></div><p>Puis on se connecte sur chaque box pour finaliser la configuration. Commençons par nous connecter sur la machine a :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">vagrant ssh boxA
</code></pre></div><p>Une fois à l&rsquo;intérieure de la machine A, on déplace et renomme les fichiers :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo mkdir /etc/nebula
sudo mv /tmp/config.yml /etc/nebula/config.yml
sudo mv /tmp/ca.crt /etc/nebula/ca.crt
sudo mv /tmp/boxA.crt /etc/nebula/host.crt
sudo mv /tmp/boxA.key /etc/nebula/host.key
sudo mkdir /opt/nebula 
sudo mv /tmp/nebula /opt/nebula/
chmod +x /opt/nebula/nebula
</code></pre></div><p>Enfin, on lance nebula en arrière plan sur cette machine :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cd /opt/nebula
sudo ./nebula -config /etc/nebula/config.yml &amp;
</code></pre></div><p>On se déconnecte de la machine A avec la commande <code>exit</code> et on recommence avec la machine B. D&rsquo;abord on s&rsquo;y connecte :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">vagrant ssh boxB
</code></pre></div><p>Puis, on déplace les fichiers de configurations et on lance nebula :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo mkdir /etc/nebula
sudo mv /tmp/config.yml /etc/nebula/config.yml
sudo mv /tmp/ca.crt /etc/nebula/ca.crt
sudo mv /tmp/boxB.crt /etc/nebula/host.crt
sudo mv /tmp/boxB.key /etc/nebula/host.key
sudo mkdir /opt/nebula 
sudo mv /tmp/nebula /opt/nebula/
chmod +x /opt/nebula/nebula
cd /opt/nebula
sudo ./nebula -config /etc/nebula/config.yml &amp;
exit
</code></pre></div><p>Maintenant, nous avons 2 machines virtuelles reliées par Nebula. Cool, mais comment vérifier que le réseau fonctionne ?</p>
<p>On se connecte sur la machine A et on tente de pinguer la machine B avec son IP Nebula, c&rsquo;est-à-dire 192.168.168.200 :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">vagrant ssh boxA

ping 192.168.168.200
</code></pre></div><p>Si tout fonctionne, le ping répond normalement. On peut faire l&rsquo;exercice inverse, c&rsquo;est-à-dire pinguer boxA depuis boxB.</p>
<p>Et enfin, pour arrêter toutes les machines virtuelles :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">vagrant halt
</code></pre></div><p>C&rsquo;est tout pour aujourd&rsquo;hui !</p>

        
        <div class="links">
            
            <span class="link">
                <a href="https://brahim.hamdouni.com/post/2022-04-01-udev-webcam/">← Udev Webcam</a>
            </span>
            
            
        </div>
    </article>
</main>

        </div></body>
</html>
